name: Build Plugin

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, x86]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone ReClass.NET
        run: git clone --depth 1 https://github.com/ReClassNET/ReClass.NET.git ReClass.NET

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: |
          nuget restore ReClass.NET\ReClass.NET\ReClass.NET.csproj -PackagesDirectory packages
          nuget restore ReClassMCP.Plugin\packages.config -PackagesDirectory packages

      - name: Build ReClass.NET
        run: |
          msbuild ReClass.NET\ReClass.NET\ReClass.NET.csproj /p:Configuration=Release /p:Platform=${{ matrix.platform }} /t:Build /v:minimal /restore

      - name: Build Plugin
        run: |
          msbuild ReClassMCP.Plugin\ReClassMCP.Plugin.csproj /p:Configuration=Release /p:Platform=${{ matrix.platform }} /t:Build /v:minimal

      - name: Prepare artifacts
        run: |
          $outDir = "artifacts"
          New-Item -ItemType Directory -Path $outDir -Force
          Copy-Item "ReClassMCP.Plugin\bin\${{ matrix.platform }}\Release\ReClassMCP.Plugin.dll" $outDir

          # Copy Newtonsoft.Json
          $jsonDll = Get-ChildItem -Path packages -Recurse -Filter "Newtonsoft.Json.dll" | Where-Object { $_.FullName -like "*net45*" } | Select-Object -First 1
          if ($jsonDll) {
            Copy-Item $jsonDll.FullName $outDir
          }

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReClassMCP-Plugin-${{ matrix.platform }}
          path: artifacts/

  package:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download x64 plugin
        uses: actions/download-artifact@v4
        with:
          name: ReClassMCP-Plugin-x64
          path: release/Plugin-x64

      - name: Download x86 plugin
        uses: actions/download-artifact@v4
        with:
          name: ReClassMCP-Plugin-x86
          path: release/Plugin-x86

      - name: Copy Python server
        run: cp -r ReClassMCP.Server release/

      - name: Create release zips
        run: |
          cd release
          zip -r ../ReClassMCP-x64.zip Plugin-x64/ ReClassMCP.Server/
          zip -r ../ReClassMCP-x86.zip Plugin-x86/ ReClassMCP.Server/

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReClassMCP-Release
          path: |
            ReClassMCP-x64.zip
            ReClassMCP-x86.zip

      - name: Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ steps.sha.outputs.short }}
          name: Build ${{ steps.sha.outputs.short }}
          files: |
            ReClassMCP-x64.zip
            ReClassMCP-x86.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
