name: Build Plugin

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, x86]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download ReClass.NET Release
        run: |
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/ReClassNET/ReClass.NET/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -like "*.rar" } | Select-Object -First 1
          if (-not $asset) {
            $asset = $release.assets | Select-Object -First 1
          }
          Write-Host "Downloading $($asset.name)..."
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "reclass.rar"

          # Extract using 7zip (pre-installed on GitHub runners)
          7z x reclass.rar -oReClass.NET-bin -y

          # Find platform-specific ReClass.NET.exe
          $reclassExe = Get-ChildItem -Path "ReClass.NET-bin" -Recurse -Filter "ReClass.NET.exe" |
            Where-Object { $_.DirectoryName -like "*${{ matrix.platform }}*" } |
            Select-Object -First 1

          # Fallback to any ReClass.NET.exe if platform-specific not found
          if (-not $reclassExe) {
            $reclassExe = Get-ChildItem -Path "ReClass.NET-bin" -Recurse -Filter "ReClass.NET.exe" | Select-Object -First 1
          }

          $refPath = $reclassExe.DirectoryName
          Write-Host "Reference path: $refPath"
          echo "RECLASS_REF_PATH=$refPath" >> $env:GITHUB_ENV

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore ReClassMCP.Plugin\packages.config -PackagesDirectory packages

      - name: Build Plugin
        run: |
          # Create a temporary csproj that references the downloaded DLLs
          $csproj = Get-Content "ReClassMCP.Plugin\ReClassMCP.Plugin.csproj" -Raw
          $csproj = $csproj -replace '<ProjectReference Include="\.\.\\ReClass\.NET\\ReClass\.NET\\ReClass\.NET\.csproj">[\s\S]*?</ProjectReference>', @"
          <Reference Include="ReClass.NET">
            <HintPath>$($env:RECLASS_REF_PATH)\ReClass.NET.exe</HintPath>
            <Private>False</Private>
          </Reference>
          "@
          $csproj | Set-Content "ReClassMCP.Plugin\ReClassMCP.Plugin.csproj"

          msbuild ReClassMCP.Plugin\ReClassMCP.Plugin.csproj `
            /p:Configuration=Release `
            /p:Platform=${{ matrix.platform }} `
            /t:Build `
            /v:minimal

      - name: Prepare artifacts
        run: |
          $outDir = "artifacts"
          New-Item -ItemType Directory -Path $outDir -Force
          Copy-Item "ReClassMCP.Plugin\bin\${{ matrix.platform }}\Release\ReClassMCP.Plugin.dll" $outDir

          # Copy Newtonsoft.Json
          $jsonDll = Get-ChildItem -Path packages -Recurse -Filter "Newtonsoft.Json.dll" | Where-Object { $_.FullName -like "*net45*" } | Select-Object -First 1
          if ($jsonDll) {
            Copy-Item $jsonDll.FullName $outDir
          }

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReClassMCP-Plugin-${{ matrix.platform }}
          path: artifacts/

  package:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download x64 plugin
        uses: actions/download-artifact@v4
        with:
          name: ReClassMCP-Plugin-x64
          path: release/Plugin-x64

      - name: Download x86 plugin
        uses: actions/download-artifact@v4
        with:
          name: ReClassMCP-Plugin-x86
          path: release/Plugin-x86

      - name: Copy Python server
        run: cp -r ReClassMCP.Server release/

      - name: Create release zips
        run: |
          cd release
          zip -r ../ReClassMCP-x64.zip Plugin-x64/ ReClassMCP.Server/
          zip -r ../ReClassMCP-x86.zip Plugin-x86/ ReClassMCP.Server/

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: ReClassMCP-Release
          path: |
            ReClassMCP-x64.zip
            ReClassMCP-x86.zip

      - name: Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Create Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ steps.sha.outputs.short }}
          name: Build ${{ steps.sha.outputs.short }}
          files: |
            ReClassMCP-x64.zip
            ReClassMCP-x86.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
